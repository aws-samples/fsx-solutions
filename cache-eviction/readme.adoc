= Amazon FSx for Lustre Cache Eviction Solution
:icons:
:linkattrs:
:imagesdir: resources/images


© 2020 Amazon Web Services, Inc. and its affiliates. All rights reserved.
This sample code is made available under the MIT-0 license. See the LICENSE file.

Errors or corrections? Contact kurdekar@amazon.com

:toc-title: Table of Contents
:toclevels: 3
:toc:


=== Overview


The Amazon FSx for Lustre Cache Eviction solution is an AWS CloudFormation template that creates AWS resources to monitor free capacity on your FSx file system. if the file system free capacity drops below the configured threshold (low-water-mark), the solution evicts (releases) space consumed by least recently accessed files on the FSx file system. 

Many enterprises and other AWS customers often store their datasets and build their data lakes on Amazon S3. Since Amazon FSx for Lustre is deeply integrated with S3, customers can create a new FSx for Lustre file system linked to their S3 bucket in minutes. FSx for Lustre file systems transparently present S3 objects as files when linked to a S3 data repository. This enables customers to use FSx as a fast cache and process data faster using a high-performance, POSIX-complaint, and fully managed file system. After processing is complete, customers can write results back to the linked S3 data repository using the data repository task API, and release space consumed by files that are no longer needed for active processing. 

When working with large datasets that span hundreds of TB's or PB's on S3, customers do not need to spin-up a FSx file system equivalent to the size of their S3 dataset. Customers can create a smaller FSx file system that is large enough to hold their active working dataset and deploy a Cache Eviction solution to manage capacity. This can help customers save on FSx file system costs. 

When a new file system is created, FSx loads the metadata for all objects in the linked S3 bucket or prefix presenting them as files or directories. Data is lazy loaded upon first access from S3 bucket or prefix, into the file system. This allows customers to create a smaller file system while providing a complete view into all the file and directories from the linked S3 bucket. The free capacity on the file system will decrease as objects are lazy loaded into the file system, new files created or existing files are modified. Once the processing is complete, customers can perform hsm_release to release the space used by the current working data set. This will only release space used by the files while retaining the metadata on the file system. The data will be lazy loaded if the files are accessed again. This provides the flexibility to free up capcaity for any new data that needs to be imported for the next processing job.


By deploying a cache eviction solution similar to the sample code provided here, customers can manage capacity on their FSx file system.  When the free capacity threshold is breached, the Cache Eviction Solution attempts to evict sufficient number of files that have not been accessed for N days until the free capacity high-water-mark can be reached. If there are not enough files available to achieve the high-water-mark, all files that have not been accessed for N days will be released and the CloudWatch Alarm will continue to be "In Alarm" state.


=== Understanding file access time updates on Lustre

Lustre will update the atime of files lazily as it is not practical to maintain fully coherent atime updates in a high-performance cluster file system.  

If the data is read from client cache, no network request is sent to Lustre file servers, as the data is in client cache. To optimize the filesystem performance, Lustre does not send request to update atime on server if it was not needed. However, if the data was not available in client cache, it will request data from the Lustre file servers and update the atime.  If an inode needs to be updated as is the case with writes, the atime is updated.

*Note*: This is a very important behavior to take into consideration while deploying the Cache Eviction Solution. As atime updates are lazy, the Cache Eviction solution may not have the most recent atime for files that have been cached locally on clients. This can lead to some recently acessed files getting evicted FSx. The metadata is still present on FSx and data will be read back from linked S3 bucket or prefix upon next access.

The FSx file system should be mounted without the noatime on the clients.


=== Environment and architecture

The Amazon FSx for Lustre Cache Eviction solution is an AWS CloudFormation template that must be launched in the same AWS region as the Amazon FSx for Lustre file system. Please refer to the link:https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/[Region Table] on the AWS Global Infrastructure site to find the AWS regions where Amazon FSx is available. The CloudFormation template creates a stack comprising of Amazon CloudWatch Alarm, Amazon SNS Topic, Amazon CloudWatch LogGroup and AWS Lambda function. The AWS CloudWatch Alarm monitors the free capacity on the file system based on a low-water-mark specified in the CloudFormation stack input. As the free capacity drops below the low-water-mark for a period of 5 minutes the CloudWatch Alarm triggers a Amazon SNS notifiction to a Lambda endpoint which invokes the AWS Lambda function. 


The AWS Lambda function performs the following steps and logs status and errors to CloudWatch Logs:

*	Queries the FSx API to identify the DNS name, mount name and subnet for your FSx for Lustre file system.
*	Generates the userdata script for the EC2 instance that will:
	**	Install python3, boto3 boto, multiprocessing_logging packages.
	**	Install the lustre 2.10 client on the EC2 instance.
	**	Mount the FSx for Lustre file system under /fsx mount path.
	**	Download the python cache eviction script fsx-cache-eviction.py from the S3 bucket to /tmp on the instance.
	**	Execute the cache eviction script and log status and errors to /<FSx mount path>/Cache-Eviction-Logs directory.
**	Invokves the EC2 API to create a new EC2 instance using this user data script. By default an m5.2xlarge instance type is launched. 


The cache eviction script executes the following steps on the temporary EC2 instance that is launched:

*	Scans the user input directory path  or root of the FSx file system to identify all files that have not been accessed in N days. 
*	Validates these least recently accessed files identified in the previous step are in a hsm state suitable for releasing the space. Files in one of these hsm states will be ignored: [" ", "dirty","released","lost","non-release","non-archive"]
*	Identifies the size and access time of these least recently accessed files.
*	Determines space used by these least recently accessed files. If total space used by these files:
		**	Is greater than target free capacity to be released (difference of free capacity high-water-mark and low-water mark), only subset of files required to achieve the desired target free capacity are released.  
		**	Is lower than target free capacity, all files are selected for eviction. The script will log a message if there are not enough files available for release.
*	Initiates a hsm release to release space used by these files.
*	Terminates the EC2 instance and sends a SNS email notification.


The execution of the Lambda function is monitored by CloudWatch. The Lambda function updates the status to the CloudWatch LogGroup created by the stack. The exectuion of the cache eviction script on the EC2 instance is logged to /<FSx Mount Path>/Cache-Eviction-Logs/.  An email notification is sent with location of the cache eviction log when the script is triggered.


The following is a diagram of the architecture.

image::cache-eviction-architecture.png[align="left", width=600]

=== Resources created

Below is a list of AWS resources created when launching the stack using the CloudFormation template.

•	CloudFormation stack
•	Lambda functions (1. Lambda Function to lookup AMI info and 2. Lambda function to trigger Cache Eviction on your FSx file system)
•	Lambda IAM roles
•	EC2 instance IAM role
•	CloudWatch Alarm
•	SNS topics

Below is a list of AWS resources created when the CloudWatch Alarm is triggered.

•	m5.2xlarge EC2 instance



=== Prerequisites
An Amazon FSx for Lustre file system created with an optional Amazon S3 data repository must exist prior to launching the AWS CloudFormation template. 

The file system should be mounted on all compute instances without the *noatimeo* mount option. A security group for the temporary EC2 instance that allows access to FSx for Lustre file system on port 988.


=== CloudFormation template inputs

The CloudFormation template takes the following inputs:
[cols="3,4"]
|===
| *Stack name*
a| *_Enter_* - *Enter a Name for your stack*
| *File system id*
a| *_Enter_* - *Enter your file system id* Ex: fs-01234567900
| *Directory path under root of FSx file system*
a| *_Enter_* - *<Subdirectory path under the FSx file system root. Leave blank if you need to scan entire file system>*
| *Low-water-mark to start FSx Cache eviction*
a| *_Enter_* - *<size in bytes>* Ex: 2400000000000 (for 2.4 TB)
| *High-water-mark to stop FSx Cache eviction*
a| *_Enter_* - *<size in bytes>* Ex: 3000000000000 (for 3.0 TB)
| *Minimum age for least recently accessed files*
a| *_Enter_* - *<minimum age of least recently accessed files to be evicted in days>* Ex: 1  (to evict files not accessed for more than 1 day)
| *Email address*
a| *_Enter_* - *<your email address to receive SNS notification>* 
| *EC2 key pair*
a| *_Select_* - *<Select your EC2 Keypair to be used for launching the temporary EC2 instance>*
| *EC2 Instance security group id*
a| *_Select_* - *<Select your security group id that will be used to launch the temporary EC2 instance>*
|===


=== Launching the stack


To launch the CloudFormation stack, click on the link below for the source AWS region and enter the input parameters. You can optionally launch the CloudFormation template from a command line using a parameter file. Links to these sample scripts are below the table.


|===
|Region | Launch template with a new VPC
| *N. Virginia* (us-east-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Ohio* (us-east-2)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?&templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *N. California* (us-west-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Oregon* (us-west-2)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Frankfurt* (eu-central-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Ireland* (eu-west-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *London* (eu-west-2)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Stockholm* (eu-north-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Singapore* (ap-southeast-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Sydney* (ap-southeast-2)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Tokyo* (ap-northeast-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

| *Hong Kong* (ap-east-1)
a| image::deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/new?templateURL=https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]
|===


==== Optional scripts (not needed if launching the stack using the table links above)

You can download the CloudFormation Template, the Lambda deployment package and the cache eviction python script from using the links provided below and customize it to meet your requirements:

The CloudFormation template.

link:https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml>[https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.yaml]

The Lambda function deployment package.

link:https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.zip>[https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-evict.zip]

The python script that runs on a temporary EC2 instance.

link:https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-eviction.py>[https://solution-references.s3.amazonaws.com/fsx/cache-eviction/fsx-cache-eviction.py]


=== Managing the Solution

Once the CloudFormation Stack is successfully deployed, you will need to confirm subscription to Amazon SNS to receive email alerts. A email subscription format will look as shown below:

You should see the following resources in your AWS mangagement console. These resources will include the CloudFormation Stack Name in the resource names:

•	CloudWatch Alarm to monitor Space on your FSx for Lustre file system
•	Lambda function that will be triggered when file system capacity drops below the configured threshold
•	Lambda IAM role
•	EC2 Instance IAM role
•	SNS topic


If you need to adjust or change the threshold value for the CloudWatch Alarm after the stack was deployed, you can do so by going to the CloudWatch console. Select the Alarm -> Click on *Actions* -> *Edit*. Then edit the value under *Define the threshold value.*

Screenshot below shows an example Alarm configured on a FSx file system by the Cache Eviction solution. The low-water-mark for the free capacity is set to 200GB.

image::Alarm.png[]

Screen shot below shows the details of the Alarm

image::Alarm-details.png[]

=== Troubleshooting


*Lambda Execution Logs*

You can find the details of the Lambda execution in your CloudWatch logs when the CloudWatch alarm is triggred.  You can check metrics for the Lambda function  by Clicking on *Monitoring* tab under your Lambda Function.

To view the execution logs Go to *Monitoring* -> Click *View logs in CloudWatch*. Next, in the CloudWatch console window, under *Log streams* click on the latest Log Stream* to view the execution events for the Lambda function.


An example output from a successful Lambda invocation is shown below:

image::lambda-function-logs.png[]


*Python Script execution logs*

Logs from execution of the python script are stored under: /<FSx Mount Path>/Cache-Eviction-Logs/

An example output from successful execution of the script is shown below:

----
24-Jul-20 22:32:54 - fsx-cache-eviction.py - INFO - Starting Cache Eviction process with input arguments: {'mountpath': '/fsx/', 'lwmfreecapacity': '200000000000', 'hwmfreecapacity': '500000000000', 'minage': '1', 'sns': 'arn:aws:sns:us-east-2:012345678920:FSxL-Cache-Evict-SNSTopicFSxLEmail-1ABCDEFGHIJK6', 'region': 'us-east-2'}

24-Jul-20 22:32:54 - fsx-cache-eviction.py - INFO - Starting discovery of files not accessed for more than 1 day on FSx mount path /fsx/

24-Jul-20 22:36:16 - fsx-cache-eviction.py - INFO - Identified 365451 files that have not been accessed for more than 1 days. See file list below:

24-Jul-20 22:36:16 - fsx-cache-eviction.py - INFO - Identified hsm state for least recently accessed files, Validating if their hsm state is suitable for hsm release

24-Jul-20 22:36:17 - fsx-cache-eviction.py - INFO - Total files identified as suitable for hsm release is: 6430 .Total files ignored due to invalid hsm state for release  is: 358985

24-Jul-20 22:36:17 - fsx-cache-eviction.py - INFO - Successfully identified last access time and size for least recently accessed files. Total files checked is: 6430

24-Jul-20 22:36:17 - fsx-cache-eviction.py - INFO - Validating capacity of files identifed as suitable for hsm release

24-Jul-20 22:36:17 - fsx-cache-eviction.py - INFO - Total size of all files that will be released is: 300006928990 bytes to free up target capacity of:  300000000000 bytes. Total number of files that will be released is: 2193

24-Jul-20 22:36:17 - fsx-cache-eviction.py - INFO - Initiating hsm release. hsm_release is a non blocking call so please wait few minutes to review the released space

24-Jul-20 22:36:49 - fsx-cache-eviction.py - INFO - Initiating termination of EC2 instance

24-Jul-20 22:36:49 - fsx-cache-eviction.py - INFO - Below is the full list of least recently accessed files on which hsm release was triggered:
[' List of files']
----

=== Additional Considerations and Recommendations
This solution covers managing the Cache Eviction process based on free capacity on your file system using a CloudWatch Alarm. You can customize this solution to run the Cache Eviction process at regular intervals using scheduled CloudWatch Event or incorporate this as part of your workflow.

Some things to keep in mind:
.	Consider using a larger instance type to run the python script. By default the solution uses m5.2xlarge.
.	Test the time taken by the Cache Eviction Process for large file systems with millions of files. you may want to consider setting up the Cache Eviction at sub directory level, and per directory vs entire file system. 


=== Deleting Resources
All AWS resources created using the CloudFormation template can be removed by deleting the CloudFormation stack. Deleting the stack will not delete the FSx for Lustre file system.

=== Participation

We encourage participation; if you find anything, please submit an issue. However, if you want to help raise the bar, **submit a PR**!
